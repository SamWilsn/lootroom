<!doctype html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Loot Room</title>
        <link
            rel="shortcut icon"
            href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAAAAABWESUoAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAHJJREFUOMtjYBgFZAEhIQIKpkzGL6/1+48uXgU7/v/fi08+4D8Q+OOWZ7sFUnCXHaeC8v9gUIZLXvwDRMEnSRwK5v2HgrnY5Q3/whT8NcUmz3joPxwcY8SiIPI/EojAlOd8gKzgMTeGAqMOFGA0mm5JBADa1GGqMpNKYgAAAABJRU5ErkJggg==">
        <link
            rel="stylesheet"
            href="https://unpkg.com/toastify-js@1.11.1/src/toastify.css"
            integrity="sha512-GjCBrfMVk9d2TgevQqgGt2FOJHBBVsTwuBdWfbxPsrcVI8zD5vfn/aR5XnaQZMh6tQ3oLHQc3X6pu1XJhs2Szg=="
            crossorigin="anonymous">

        <style>
        @font-face {
            font-family: 'abhaya';
            src: url('/fonts/AbhayaLibre-Regular-webfont.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        button:active {
            border-style: inset;
        }
        button {
            background: black;
            border: 1px solid #8e8e8e;
            box-shadow: 0 0 0 5px black;
            color: #8e8e8e;
            padding: 10px;
            font-family: abhaya;
            font-size: 24px;
            cursor: pointer;
            border-radius: 4px;
        }
        body {
            font-family: abhaya,serif;
            color: #fff;
            background-color: #1a1a1a;
            line-height: 1.3;
        }
        a {
            text-decoration: underline dotted;
            color: #838383;
        }
        a:hover {
            text-decoration: underline;
            text-decoration-thickness: 1px;
        }
        ul {
            padding: 15px 20px;
            font-size: 20px;
            max-width: 800px;
            margin:0 auto;
            display: flex;
            align-items: center;
            list-style: none;
            justify-content: right;
        }
        ul > li {
            margin-right: 10px;
        }
        ul > li:last-child {
            margin-right: 0;
        }
        nav a, header a {
            text-decoration: none;
        }
        nav .title {
            margin-right: auto;
            color: #fff;
            font-size: 24px;
        }
        h1 {
            text-align: center;
            font-size: 5rem;
            font-weight: normal;
            margin-bottom: 0;
        }
        header {
            max-width: 800px;
            margin: 0 auto;
        }
        dt {
            font-size: 20px;
        }
        dd {
            color: #8e8e8e;
        }
        header > p {
            text-align: center;
            color: #8e8e8e;
            font-size: 22px;
        }
        header a { color: #fff; }

        hr {
            margin: 44px 0 22px 0;
            max-width: 100vw;
            height: 1.5vw;
            border:0;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNTY5Ljk5IiBoZWlnaHQ9IjI2LjYyMSIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgMTUwLjgxIDcuMDQzNSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC43MDAwNyAtMTQ0Ljg4KSI+CiAgPHJlY3QgdHJhbnNmb3JtPSJyb3RhdGUoNDUpIiB4PSIxNTUuMjciIHk9IjQ5LjYyNSIgd2lkdGg9IjQuOTgwNSIgaGVpZ2h0PSI0Ljk4MDUiIGZpbGw9IiNmZmYiIHN0cm9rZS13aWR0aD0iLjA0MTk3MSIvPgogIDxwYXRoIGQ9Im04Mi45NDMgMTQ4LjVoNjcuMTY3IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMS4xMjQxIi8+CiAgPHBhdGggZD0ibTY2LjQ2NSAxNDguNWgtNjcuMTY3IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMS4xOTQiLz4KIDwvZz4KPC9zdmc+Cg==);
        }

        .sale {
            width: 400px;
            display: block;
            max-width: 100%;
            margin: 10px;
            color: #8e8e8e;
            text-align: justify;
            text-align-last: center;
        }

        .subtitle {
            justify-content: center;
            font-size: 22px;
        }

        #lotDescription {
            text-transform: lowercase;
        }

        #lot {
            border: none;
            background-color: #000;
        }

        main {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: center;
        }

        section {
            max-width: 800px;
            margin: 0 auto;
        }
        </style>
    </head>
    <body>
        <nav>
            <ul>
                <li class="title">
                    Loot Room
                </li>
                <li>
                    <a href="https://www.lootproject.com/">Loot</a>
                </li>
                <li>
                    <a href="#faq">FAQ</a>
                </li>
            </ul>
        </nav>
        <header>
            <h1>Loot Room</h1>
            <ul class="subtitle">
                <li>
                    <a href="https://opensea.io/collection/loot-room">OpenSea</a>
                </li>
                <li>
                    <a href="https://twitter.com/Loot_Room">Twitter</a>
                </li>
                <li>
                    <a href="https://etherscan.io/address/0x2DC4b124727B58874538b713c2f30eAD6dC39d02#code">Contract</a>
                </li>
            </ul>
            <p>
                Loot Rooms are randomized dungeon tiles generated and stored
                on-chain.
                <br>
                In the spirit of <a href="https://www.lootproject.com/">Loot</a>,
                feel free to use these rooms however you like.
                <br>
                Loot Rooms are not affiliated with the original Loot
                developers&mdash;but<br>we really appreciate their work.
            </p>
        </header>
        <hr>
        <main>
            <div class="sale">
                <h2 id="lotName"></h2>
                <p id="lotDescription"></p>
            </div>
            <img class="sale" id="lot" src="/images/spinner.svg">
            <div class="sale">
                <button id="buy">
                </button>
            </div>
        </main>
        <hr>
        <section>
            <h2 id="faq">Frequently Asked Questions</h2>
            <dl>
                <dt>What is Loot Room?</dt>
                <dd>
                    <p>
                    Loot Room is a collection of dungeon tiles, originally
                    released by <a href="https://twitter.com/_SamWilsn_">Sam Wilson</a>.
                    Now (and practically forever) anyone can mint a Loot Room, often for free. Each Loot Room is one of six kinds, is described by four randomly selected attributes like size and material, and can have up to four containers.
                    </p>
                    <p>
                    Loot Room is an unaudited project, and like any dungeon, enter at
                    your own risk.
                    </p>
                </dd>
                <dt>How much does it cost to mint a Loot Room?</dt>
                <dd>
                    <p>
                    Initially each Loot Room is offered for sale through a
                    descending price auction (or <a href="https://en.wikipedia.org/wiki/Dutch_auction">Dutch auction</a>) over 6650 blocks, or about one day. After that, the room is free to mint for anyone, just pay for gas!
                    </p>

                    <p>
                    The auction starts at four times the previous sale price or 1 Ether, whichever is greater.
                    </p>
                </dd>
                <dt>Do Loot holders get anything special?</dt>
                <dd>
                    <p>
                    Yes! Each Loot token entitles its holder to one free Loot
                    Room. Just head over to <a id="etherscan">Etherscan</a> to
                    claim.
                    </p>
                </dd>
            </dl>
        </section>
        <footer></footer>

        <script
            src="https://unpkg.com/web3modal@1.9.4/dist/index.js"
            integrity="sha512-EE/BuYRMEDF3L86HncfC+aqVankbEgM/69Xr2D7iCQOuzJOZM5ipcTbVM6Ig6v3ksf5rPhAc1Pl85BSyin9djQ=="
            crossorigin="anonymous"></script>

        <script
            src="https://unpkg.com/@walletconnect/web3-provider@1.6.5/dist/umd/index.min.js"
            integrity="sha512-GBMWLoYZT71VgEI+p8vMsnZxWGObMdY3NJiltvRpfq1mtV6FIiO7zAiYvkiJaOVzjBIpSR+VWMGLZfHr+ppvpA=="
            crossorigin="anonymous"></script>

        <script
            src="https://unpkg.com/ethers@5.4.6/dist/ethers.umd.min.js"
            integrity="sha512-2YGDJl67sf9MMyIBoFQOq5fOibZ+aAmHoeLpk//WdVNQfGgOL+NojR63rsuyHkEh8o65P724Yg6N7aF5XIQvmg=="
            crossorigin="anonymous"></script>

        <script
            src="https://unpkg.com/toastify-js@1.11.1/src/toastify.js"
            integrity="sha512-55m+nq7bzqdQz2vF9AXOYTZtmoikiXcW1XnHNStnk464ewHBwhEeC5z6aqukJ/7n7Y+veO3gPunMydgaX4J8nQ=="
            crossorigin="anonymous"></script>

        <script>
            (function() {
                "use strict";

                const Web3Modal = window.Web3Modal.default;
                const WalletConnectProvider = window.WalletConnectProvider.default;

                // Build the contract.
                const network = "homestead";
                const contractAddress = "0x2DC4b124727B58874538b713c2f30eAD6dC39d02";
                const openseaBase = "https://opensea.io/assets/";
                const etherscanBase = "https://etherscan.io/address/";

                // const network = "rinkeby";
                // const contractAddress = "0x730b781A2f763a576c914d49424875f6F7F8A331";
                // const openseaBase = "https://testnets.opensea.io/assets/";
                // const etherscanBase = "https://rinkeby.etherscan.io/address/";

                const infuraId = "7074adf98cbc4afaabda2e09151b8e4b";
                const etherscanId = "HYND2S92S8FDTGJYQFNCAZBHKFI2R2TSVH";
                const alchemyId = "lFUJaQ4O4OLdlIVy0MmVWRnjnRiQAVV_";
                const pocketId = "61314d5ddf1ea70035db54d4";

                const contractAbi = [
                    {
                        "inputs": [
                            {
                                "internalType": "contract LootRoom",
                                "name": "render",
                                "type": "address"
                            },
                            {
                                "internalType": "contract IERC721",
                                "name": "loot",
                                "type": "address"
                            }
                        ],
                        "stateMutability": "nonpayable",
                        "type": "constructor"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "approved",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "Approval",
                        "type": "event"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "operator",
                                "type": "address"
                            },
                            {
                                "indexed": false,
                                "internalType": "bool",
                                "name": "approved",
                                "type": "bool"
                            }
                        ],
                        "name": "ApprovalForAll",
                        "type": "event"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "previousOwner",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "newOwner",
                                "type": "address"
                            }
                        ],
                        "name": "OwnershipTransferred",
                        "type": "event"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "Transfer",
                        "type": "event"
                    },
                    {
                        "inputs": [],
                        "name": "AUCTION_BLOCKS",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "AUCTION_MINIMUM_START",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "approve",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            }
                        ],
                        "name": "balanceOf",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "buy",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "payable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "lootTokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "claim",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "getApproved",
                        "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "getForSale",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "getPrice",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "operator",
                                "type": "address"
                            }
                        ],
                        "name": "isApprovedForAll",
                        "outputs": [
                            {
                                "internalType": "bool",
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "name",
                        "outputs": [
                            {
                                "internalType": "string",
                                "name": "",
                                "type": "string"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "owner",
                        "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "ownerOf",
                        "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "renounceOwnership",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "safeBuy",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "payable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "lootTokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "safeClaim",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "safeTransferFrom",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bytes",
                                "name": "_data",
                                "type": "bytes"
                            }
                        ],
                        "name": "safeTransferFrom",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "operator",
                                "type": "address"
                            },
                            {
                                "internalType": "bool",
                                "name": "approved",
                                "type": "bool"
                            }
                        ],
                        "name": "setApprovalForAll",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "bytes4",
                                "name": "interfaceId",
                                "type": "bytes4"
                            }
                        ],
                        "name": "supportsInterface",
                        "outputs": [
                            {
                                "internalType": "bool",
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "symbol",
                        "outputs": [
                            {
                                "internalType": "string",
                                "name": "",
                                "type": "string"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "tokenURI",
                        "outputs": [
                            {
                                "internalType": "string",
                                "name": "",
                                "type": "string"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "transferFrom",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "newOwner",
                                "type": "address"
                            }
                        ],
                        "name": "transferOwnership",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address payable",
                                "name": "to",
                                "type": "address"
                            }
                        ],
                        "name": "withdraw",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    }
                ];

                const roProvider = ethers.getDefaultProvider(network, {
                    infura: infuraId,
                    etherscan: etherscanId,
                    alchemy: alchemyId,
                    pocket: pocketId
                });

                const roContract = new ethers.Contract(
                    contractAddress,
                    contractAbi,
                    roProvider
                );

                const Tier1 = ethers.BigNumber.from("100000000000000");
                const Tier2 = ethers.BigNumber.from("100000");

                const reload = () => { location.reload(); };

                const humanize = function(num) {
                    let divisor;
                    let unit;
                    let hunit;

                    if (num.gte(Tier1)) {
                        divisor = Tier1;
                        unit = "ether";
                        hunit = "Ether";
                    } else if (num.gte(Tier2)) {
                        divisor = Tier2;
                        unit = "gwei";
                        hunit = "Gwei";
                    } else if (num.isZero()) {
                        return "Free";
                    } else {
                        divisor = ethers.constants.One;
                        unit = "wei";
                        hunit = "Wei";
                    }

                    num = ethers.constants.One.add(
                        num.sub(ethers.constants.One).div(divisor)
                    );

                    num = num.mul(divisor);

                    return ethers.utils.formatUnits(num, unit) + ' ' + hunit;
                };

                const ready = new Promise(resolve => {
                    if (document.readyState === 'loading') {
                        document.addEventListener(
                            "DOMContentLoaded",
                            () => resolve(document)
                        );
                    } else {
                        resolve(document);
                    }
                });

                const fetchForSale = async function() {
                    const forSale = await roContract.getForSale();

                    const price = await roContract.getPrice();

                    const tokenURI = await roContract.tokenURI(forSale);
                    const response = await fetch(tokenURI);
                    const metadata = await response.json();
                    const doc = await ready;

                    const lotImg = doc.getElementById("lot");
                    lotImg.src = metadata.image;
                    lotImg.alt = metadata.name;

                    const lotName = doc.getElementById("lotName");
                    lotName.textContent = metadata.name;
                    lotDescription.textContent = metadata.description;

                    const buy = doc.getElementById("buy");
                    const humanPrice = humanize(price);
                    buy.textContent = `Mint for ${humanPrice}`;
                };

                const etherscanLink = async function() {
                    const doc = await ready;
                    const elem = doc.getElementById("etherscan");
                    elem.href = `${etherscanBase}${contractAddress}#writeContract`;
                };

                const setup = async function() {
                    const doc = await ready;

                    const btn = doc.getElementById("buy");

                    let provider = null;
                    let contract = null;

                    const onMint = function(currentAddress, dest, tokenId) {
                        if (currentAddress === dest) {
                            Toastify({
                                text: "room arrived",
                                close: true,
                                duration: -1,
                                destination: `${openseaBase}${contractAddress}/${tokenId}`,
                                newWindow: true
                            }).showToast();
                        }

                        fetchForSale();
                    };

                    const connectProvider = async function() {
                        const providerOptions = {
                            walletconnect: {
                                package: WalletConnectProvider,
                                options: {
                                  infuraId: infuraId
                                }
                            }
                        };

                        const web3Modal = new Web3Modal({
                            network: network === "homestead" ? "mainnet" : network,
                            cacheProvider: false,
                            providerOptions
                        });

                        let modalProvider;
                        try {
                            modalProvider = await web3Modal.connect();
                        } catch (e) {
                            if (e === "Modal closed by user") {
                                return;
                            } else {
                                throw e;
                            }
                        }

                        const web3Provider = new ethers.providers.Web3Provider(modalProvider);
                        provider = web3Provider.getSigner();

                        const providerNetwork = await web3Provider.getNetwork();

                        if (providerNetwork.name !== network) {
                            // Disconnect as well as possible from the provider.
                            try {
                                await modalProvider.disconnect();
                            } catch (e) {
                                console.log(e);

                                try {
                                    await modalProvider.request({
                                        method: "wallet_requestPermissions",
                                        params: [{eth_accounts: {}}]
                                    });
                                } catch (f) {
                                    console.log(f);
                                }
                            }

                            alert(`wrong network: ${providerNetwork.name} is not ${network}`);
                            provider = null;
                            contract = null;
                            return;
                        }

                        contract = roContract.connect(provider);

                        const currentAddress = await provider.getAddress();
                        const filter = contract.filters.Transfer("0x0000000000000000000000000000000000000000", null);
                        contract.on(
                            filter,
                            (from, to, tokenId) => onMint(
                                currentAddress,
                                to,
                                tokenId
                            )
                        );

                        modalProvider.on("accountsChanged", reload);
                        modalProvider.on("chainChanged", reload);
                        modalProvider.on("disconnect", reload);
                    };

                    const onClickInner = async function onClick(evt) {
                        evt.preventDefault();

                        if (provider === null) {
                            await connectProvider();
                        }

                        if (provider === null) {
                            return;
                        }

                        const tokenId = await contract.getForSale();
                        const price = await contract.getPrice();

                        await contract.safeBuy(tokenId, {value: price});
                    };

                    const onClick = async function(evt) {
                        try {
                            await onClickInner(evt);
                        } catch (e) {
                            contract = null;
                            provider = null;
                            console.log(e);
                            let msg = (""+e).substring(0, 50);
                            alert("unhandled exception: " + msg);
                            reload();
                        }
                    };

                    btn.addEventListener("click", onClick);
                };

                etherscanLink();
                fetchForSale();
                setup();
            }());
        </script>
    </body>
</html>
